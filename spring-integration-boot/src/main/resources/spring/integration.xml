<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:file="http://www.springframework.org/schema/integration/file"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:http="http://www.springframework.org/schema/integration/http"
       xmlns="http://www.springframework.org/schema/beans"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/integration/file http://www.springframework.org/schema/integration/file/spring-integration-file.xsd
                           http://www.springframework.org/schema/integration/http http://www.springframework.org/schema/integration/http/spring-integration-http.xsd">


    <bean id="lineSplitterBean" class="cz.profinit.training.springadvanced.integration.LineSplitter"/>

    <bean id="csvToMapTransformer" class="cz.profinit.training.springadvanced.integration.CsvToMapTransformer">
        <constructor-arg name="delimiter" value=","/>
        <constructor-arg name="fieldNames">
            <list>
                <value>name</value>
                <value>description</value>
            </list>
        </constructor-arg>
    </bean>

    <file:inbound-channel-adapter channel="filesIn" directory="C:\Temp\csops\input" prevent-duplicates="false">
        <int:poller id="poller" fixed-delay="5000"/>
    </file:inbound-channel-adapter>

    <int:channel id="filesIn">
        <int:interceptors>
            <int:wire-tap channel="filesToRead"/>
        </int:interceptors>
    </int:channel>

    <file:file-to-string-transformer input-channel="filesToRead" output-channel="stringIn"/>

    <int:splitter input-channel="stringIn" output-channel="lines" ref="lineSplitterBean"/>

    <int:transformer input-channel="lines" output-channel="javamaps" ref="csvToMapTransformer"/>

    <int:header-enricher input-channel="javamaps" output-channel="restOut">
        <int:header name="Content-Type" value="application/json"/>
    </int:header-enricher>

    <http:outbound-channel-adapter id="restOut"
                                   url="http://localhost:8080/lists"
                                   http-method="POST"/>

    <file:outbound-channel-adapter channel="filesIn" directory="C:\Temp\csops\output" delete-source-files="true"/>


</beans>