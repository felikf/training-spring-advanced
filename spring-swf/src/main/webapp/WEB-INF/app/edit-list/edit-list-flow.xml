<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns="http://www.springframework.org/schema/webflow"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd">

    <input name="listId"/>

    <decision-state id="isNew">
        <if test="listId == null"
            then="edit-new-list"
            else="edit-list"/>
    </decision-state>


    <view-state id="edit-new-list" view="edit-list.xhtml">
        <on-entry>
            <evaluate result="flowScope.items" expression="T(java.util.Collections).emptyList()"
                      result-type="dataModel"/>
            <evaluate result="viewScope.list" expression="modelService.createList()"/>
        </on-entry>
        <transition on="add-item" to="add-item"/>
        <transition on="edit-item" to="edit-item"/>
        <transition on="save" to="end">
            <evaluate expression="modelService.saveMList(list)"/>
        </transition>
        <transition on="cancel" to="end"/>
    </view-state>

    <view-state id="edit-list">
        <on-entry>
            <evaluate result="flowScope.items" expression="listService.getListItems(listId)" result-type="dataModel"/>
            <evaluate result="viewScope.list" expression="modelService.readMlist(listId)"/>
        </on-entry>
        <transition on="add-item" to="add-item"/>
        <transition on="edit-item" to="edit-item"/>
        <transition on="save" to="end">
            <evaluate expression="modelService.saveMList(list)"/>
        </transition>
        <transition on="cancel" to="end"/>
    </view-state>

    <subflow-state id="add-item" subflow="edit-item">
        <input name="listId" value="listId"/>
        <input name="itemId" value="null"/>
        <transition to="edit-list"/>
    </subflow-state>

    <subflow-state id="edit-item" subflow="edit-item">
        <input name="listId" value="listId"/>
        <input name="itemId" value="items.selectedRow.id"/>
        <transition to="edit-list"/>
    </subflow-state>

    <end-state id="end"/>

</flow>